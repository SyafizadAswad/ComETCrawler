var totoPromotionRecommend_initialized = false;

(function($, json2){
	if(totoPromotionRecommend_initialized) return;
	totoPromotionRecommend_initialized = true;
	jQuery.support.cors = true;
	$.totoPromotionRecommend = { // application context
			"loadPromotionRecommendData" : function(opts){
				if(!opts || !opts.target) return;
				$(opts.target).html("").hide();
				if (typeof(opts) == "string") opts = { "url" : opts };
				var settings = {
					"apiOptions" : {
						"url" : opts.url,
						"method" : "post",
						"type" : "json",
						"success" : function(result, status) {
							if(!result.data || !result.data.length || result.data.length < 1) return;
							if(!opts.target) return;
							var is_smartphone = $("#is_smartphone").val();
							if(is_smartphone != "1") is_smartphone = "0";
							var is_logined = $("#is_logined").val();
							if(is_logined != "1") is_logined = "0";

							var headerName = opts.headerName;
							if(headerName != null && headerName != ""){//おすすめ情報タイトルの文字数チェック追加
								if(headerName.length > 36){
									if(headerName.match("」に関する$")){
										headerName = headerName.substr(0, 30) + "…」に関する";
									}else if(headerName.match("に関する$")){
											headerName = headerName.substr(0, 31) + "…に関する";
									}else if(headerName.match("様への$")){
										headerName = headerName.substr(0, 32) + "…様への";
									}else{
										headerName = headerName.substr(0, 35) + "…";
									}
								}
							}
							headerName = headerName ? headerName + "おすすめ情報" : "おすすめ情報";
							var contentsHTML = null;

							var recommendDataFlag = 0;//リコメンドデータ存在有無フラグ
							for(var i = 0; i < result.data.length; i++){
								var category = result.data[i];
								var categoryRecommentHTML = null;
								if(!category.list || !category.list.length || category.list.length < 1) continue;
								recommendDataFlag = 1;//リコメンドデータが存在する場合、1に更新する
								for(var j = 0; j < category.list.length; j++){
									var recommend = category.list[j];
									var title = recommend.title && recommend.title.value ? recommend.title.value : "";
									if(title != null && title != ""){//タイトル文字数チェック追加
										if(title.length > 30) title = title.substr(0, 29) + "…";
									}
									var titleUrl = recommend.title && recommend.title.url ? recommend.title.url : "javascript:void(0);";
									if(category.code == "Catalogue"){
										if(titleUrl.indexOf("javascript:void(0);") < 0){
											var parameter = "";
											if(is_smartphone == "1" && is_logined == "1") parameter = "is_smartphone=1&is_logined=1";
											else if(is_smartphone == "1") parameter = "is_smartphone=1";
											else if(is_logined == "1") parameter = "is_logined=1";
											if(parameter != ""){
												if(titleUrl.indexOf("?") < 0){
													titleUrl = titleUrl + "?" + parameter;
												}else {
													titleUrl = titleUrl + "&" + parameter;
												}
											}
										}
									}
									var body = recommend.body && recommend.body.value ? recommend.body.value : "";
									if(body != null && body != ""){//本文文字数チェック追加
										if(body.length > 48) body = body.substr(0, 47) + "…";
									}
									var thumbnailUrl = recommend.thumbnail && recommend.thumbnail.url ? recommend.thumbnail.url : "";
									if(thumbnailUrl != null && thumbnailUrl.indexOf("//") == 0){
										thumbnailUrl = $(location).attr("protocol") + thumbnailUrl;
									}else {
										if(opts.thumbnailUrlPrefix != null && opts.thumbnailUrlPrefix != ""){
											if(thumbnailUrl != null && thumbnailUrl.indexOf("http") != 0){
												if(thumbnailUrl.indexOf("/") == 0)
													thumbnailUrl = opts.thumbnailUrlPrefix + thumbnailUrl.substr(1);
												else
													thumbnailUrl = opts.thumbnailUrlPrefix + thumbnailUrl;
											}
										}
									}

									var windowName = null;
									if(opts.linkWindowName) windowName = opts.linkWindowName(category, recommend);
									if(windowName == null || windowName == "") windowName = "_blank";
									var recommentHTML = "\t\t\t<a href='" + titleUrl + "' class='promoRecommend_block' target='" + windowName + "' >\r\n\t\t\t\t<p class='promoRecommend_name'>" +
										title + "</p>\r\n\t\t\t\t<figure class='promoRecommend_img'><img src='" + thumbnailUrl + "' alt='" + title +
										"'></figure>\r\n\t\t\t\t<p class='promoRecommend_txt'>" + body + "</p>\r\n\t\t\t</a>";

									categoryRecommentHTML = categoryRecommentHTML ? categoryRecommentHTML + "\r\n" + recommentHTML : recommentHTML;
								}
								if(!categoryRecommentHTML) continue;
								var categoryAreaHtml = "<li class='promoRecommend_item' data-mh='promoRecommend_item' style='height: 332px;'>\r\n\t\t<p class='promoRecommend_title'>" +
									category.name + "</p>\r\n" + categoryRecommentHTML + "\r\n\t</li>";
								contentsHTML = contentsHTML ? contentsHTML + "\r\n\t" + categoryAreaHtml : categoryAreaHtml;
							}

							var assetsPath = (opts.assetsPath != null && opts.assetsPath != "") ? opts.assetsPath : "/local/recommend/";
							if(contentsHTML){
								var resultHTML =
									"<h2 class='promotion_title promotion_title-recommend'>" + headerName + "</h2>" +
										"\r\n\t\t\t\t\t<div class='promotion_contents js-scrollBox ps-container ps-active-y'>\r\n\t\t\t\t\t\t<div class='promotion_contentsInner' style='display: block;'>" +
										"\r\n<div class='promoRecommend'>\r\n\t<ul class='promoRecommend_list'>\r\n\t" +
										contentsHTML + "\r\n\t</ul>\r\n</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>";

								$(opts.target).html(resultHTML).show();
							}
							//html作成後、PIECE側から受け取るコールバック関数の実行
							var callback = opts.callback;
							if(callback) callback(recommendDataFlag);
						},
						"error" : function(result, status, errorThrown) {
							//PIECE側から受け取るコールバック関数の実行
							var callback = opts.callback;
							var recommendDataFlag = 0;//リコメンドデータ存在有無フラグ。エラーの場合はデータ0件を意味する0とする。
							if(callback) callback(recommendDataFlag);
						}
					}
				};
				opts = $.extend(true, {}, settings.apiOptions, opts);

				if(opts.url == null || opts.url == ""){
					opts.error($.totoPromotionRecommend.formatData({ "message" : { "id" : "", "body" : "error.(url is empty.)" }}), "");
					return;
				}

				var params = $.isArray(opts.params) || $.isPlainObject(opts.params) ? json2.stringify(opts.params) : String(opts.params);

				return $.ajax({
					"url" : opts.url,
					"type" : opts.method,
					"data" : {
						"content" : params
					},
					"dataType" : opts.type,
					"success" : function(data, textStatus, jqXHR) {
						data = $.totoPromotionRecommend.formatData(data);
						if(!$.totoPromotionRecommend.isSuccess(data)){
							opts.error(data, textStatus);
						}else{
							opts.success(data, textStatus);
						}
					},
					"error" : function(jqXHR, textStatus, errorThrown) {
						opts.error($.totoPromotionRecommend.formatData({ "message" : { "id" : "", "body" : errorThrown }}), textStatus, errorThrown);
					}
				});
			},
			"formatData" : function(data) {
				if (!data || !data.message) {
					data = $.extend({
							"message" : { "id" : "MZZEG9999", "body" : "Unknown Error." }
					}, data || {});
				}
				return data;
			},
			"isSuccess" : function(data){
				if(data == null) return false;
				var status = data.status_code;
				if(status == null || status == "") return false;
				return status.indexOf("200") === 0;
			}
		};
})(window.jQuery, window.JSON);

