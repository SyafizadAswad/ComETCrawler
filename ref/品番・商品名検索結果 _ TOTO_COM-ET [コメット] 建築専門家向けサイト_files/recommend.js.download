var totoRecommend_initialized = false;

(function($, json2){
	if(totoRecommend_initialized) return;
	totoRecommend_initialized = true;
	jQuery.support.cors = true;
	$.totoRecommend = { // application context
			"loadRecommendData" : function(opts){
				if(!opts || !opts.target) return;
				$(opts.target).html("").hide();
				if (typeof(opts) == "string") opts = { "url" : opts };
				var settings = {
					"apiOptions" : {
						"url" : opts.url,
						"method" : "post",
						"type" : "json",
						"success" : function(result, status) {
							if(!result.data || !result.data.length || result.data.length < 1) return;
							if(!opts.target) return;
							var is_smartphone = $("#is_smartphone").val();
							if(is_smartphone != "1") is_smartphone = "0";
							var is_logined = $("#is_logined").val();
							if(is_logined != "1") is_logined = "0";

							var headerName = opts.headerName ? opts.headerName + "おすすめ情報" : "おすすめ情報";
							var contentsHTML = null;

							for(var i = 0; i < result.data.length; i++){
								var category = result.data[i];
								var categoryRecommentHTML = null;
								if(!category.list || !category.list.length || category.list.length < 1) continue;
								for(var j = 0; j < category.list.length; j++){
									var recommend = category.list[j];
									var title = recommend.title && recommend.title.value ? recommend.title.value : "";
									var titleUrl = recommend.title && recommend.title.url ? recommend.title.url : "javascript:void(0);";
									if(category.code == "Catalogue"){
										if(titleUrl.indexOf("javascript:void(0);") < 0){
											var parameter = "";
											if(is_smartphone == "1" && is_logined == "1") parameter = "is_smartphone=1&is_logined=1";
											else if(is_smartphone == "1") parameter = "is_smartphone=1";
											else if(is_logined == "1") parameter = "is_logined=1";
											if(parameter != ""){
												if(titleUrl.indexOf("?") < 0){
													titleUrl = titleUrl + "?" + parameter;
												}else {
													titleUrl = titleUrl + "&" + parameter;
												}
											}
										}
									}
									var body = recommend.body && recommend.body.value ? recommend.body.value : "";
									var thumbnailUrl = recommend.thumbnail && recommend.thumbnail.url ? recommend.thumbnail.url : "";
									if(thumbnailUrl != null && thumbnailUrl.indexOf("//") == 0){
										thumbnailUrl = $(location).attr("protocol") + thumbnailUrl;
									}else {
										if(opts.thumbnailUrlPrefix != null && opts.thumbnailUrlPrefix != ""){
											if(thumbnailUrl != null && thumbnailUrl.indexOf("http") != 0){
												if(thumbnailUrl.indexOf("/") == 0)
													thumbnailUrl = opts.thumbnailUrlPrefix + thumbnailUrl.substr(1);
												else
													thumbnailUrl = opts.thumbnailUrlPrefix + thumbnailUrl;
											}
										}
									}

									var windowName = null;
									if(opts.linkWindowName) windowName = opts.linkWindowName(category, recommend);
									if(windowName == null || windowName == "") windowName = "_blank";
									var recommentHTML = "\t\t<a href='" + titleUrl + "' target='" + windowName + "'>\r\n\t\t\t<p class='img'><img src='" + thumbnailUrl + "' alt='" + title + "' /></p>\r\n\t\t\t" +
										"<dl class='noAround'>\r\n\t\t\t\t" +
										"<dt>" + title + "</dt>\r\n\t\t\t\t" +
										"<dd>" + body + "</dd>\r\n\t\t\t</dl>\r\n\t\t</a>";

									categoryRecommentHTML = categoryRecommentHTML ? categoryRecommentHTML + "\r\n" + recommentHTML : recommentHTML;
								}
								if(!categoryRecommentHTML) continue;
								var categoryAreaHtml = "<li>\r\n\t\t<h4 class='headLine4'>" + category.name + "</h4>\r\n" + categoryRecommentHTML + "\r\n\t</li>";
								contentsHTML = contentsHTML ? contentsHTML + "\r\n\t" + categoryAreaHtml : categoryAreaHtml;
							}

							var assetsPath = (opts.assetsPath != null && opts.assetsPath != "") ? opts.assetsPath : "/local/recommend/";
							if(contentsHTML){
								var containerHeaderHTML =
									"<p class='recommendFixed js-recommendFixed'>" +
									"	<a href='javascript: void(0);' class='recommendFixed_txt js-recommendFixed_txt js-rollover'><img src='" + assetsPath + "recommend_fixed_tab.png' alt=''></a>" +
									"	<a href='javascript: void(0);' class='recommendFixed_hide js-recommendFixed_hide js-rollover'><img src='" + assetsPath + "recommend_fixed_tab_close.png' alt='閉じる'></a>" +
									"</p>" +
									"<div class='recommendModal'>" +
									"	<div class='recommendModal_overlay'></div>" +
									"	<div class='recommendModal_content'>";

								var containerFooterHTML =
									"	</div>" +
									"</div>";
//									"<p class='recommendFixed-sp js-recommendFixed'><a href='#recommendArea' class='recommendFixed_txt-sp'><span>おすすめ情報</span></a><a href='javascript:void(0);' class='recommendFixed_hide-sp js-recommendFixed_hide'><span><img src='../assets/images/smartphone/shared/recommend_fixed_close.png' alt='見出し見出し'></span></a></p>";

								var closeButtonHTML = "<a href='javascript:void(0);' class='recommendModal_close'><img src='" + assetsPath + "btn_close.png' alt='閉じる'></a>";
								var modalHTML = containerHeaderHTML +
									"<h3 class='headLine3'>" + headerName + closeButtonHTML + "</h3>\r\n<ul class='recommendList'>\r\n\t" + contentsHTML + "\r\n</ul>" + containerFooterHTML;
								var resultHTML =
									"<h3 class='headLine3'>" + headerName + "</h3>\r\n<ul class='recommendList'>\r\n\t" + contentsHTML + "\r\n</ul>";

//								$(opts.target).html(resultHTML).show();
//								$(opts.target).closest("body").append(modalHTML);
								//recommendButtonHideFlagがオンの場合は、おすすめ情報ボタンを表示しない。（modalHTMLではなく、resultHTMLを設定する。）
								if(opts.recommendButtonHideFlag != null && opts.recommendButtonHideFlag != ""){
									if(opts.recommendButtonHideFlag === true){
										$(opts.target).html(resultHTML).show();
									}else{
										$(opts.target).html(resultHTML).show().append(modalHTML);
									}
								}else{
									$(opts.target).html(resultHTML).show().append(modalHTML);
								}

								//from shift js
								$('.recommendList li a:last-child').addClass('last');

								$('.recommendList').each(function(){
									$(this).flatHeight({
										column:3
									});
								});
								$('.recommendList .flatHeightItem').css('height', '351px');

								//recommendのついてくるタブ  ---------------------------
								var recommenFixed = {
									topLine: $('#gHeader').height() + $('#gNav').height(),
									elem: $('.js-recommendFixed'),
									hide: function(){
										recommenFixed.elem.fadeOut(200);
										/*recommenFixed.elem.animate({
											right: -1 * 50
										}, 300, function(){
											$(this).hide();
										})*/
									},
									open: function(){
										$('.recommendModal').fadeIn(400),
										$('.recommendModal_content').css({
											top: $(window).scrollTop() + 20
										});
//										$('.recommendModal_content .flatHeightItem').css('height', 'auto');
										$('.recommendModal_content .flatHeightItem').css('height', '351px');
										$('.recommendModal_content .flatHeight').flatHeight();
									},
									close: function(){
										$('.recommendModal').fadeOut(400)
									}
								}
								$(document).on('click', '.js-recommendFixed_txt', function(event) {
									event.preventDefault();
									recommenFixed.open();
								});

								$(document).on('click', '.js-recommendFixed_hide', function(event) {
									event.preventDefault();
									recommenFixed.hide();
								});
								$(document).on('click', '.recommendModal_close, .recommendModal_overlay', function(event) {
									event.preventDefault();
									recommenFixed.close();
								});
								//recommendのついてくるタブ  ---------------------------
							}
						},
						"error" : function(result, status, errorThrown) {
							/*if(result.message){
								alert(result.message.code + ":" + result.message.body);
							}*/
						}
					}
				};
				opts = $.extend(true, {}, settings.apiOptions, opts);

				if(opts.url == null || opts.url == ""){
					opts.error($.totoRecommend.formatData({ "message" : { "id" : "", "body" : "error.(url is empty.)" }}), "");
					return;
				}

				var params = $.isArray(opts.params) || $.isPlainObject(opts.params) ? json2.stringify(opts.params) : String(opts.params);

				return $.ajax({
					"url" : opts.url,
					"type" : opts.method,
					"data" : {
						"content" : params
					},
					"dataType" : opts.type,
					"success" : function(data, textStatus, jqXHR) {
						data = $.totoRecommend.formatData(data);
						if(!$.totoRecommend.isSuccess(data)){
							opts.error(data, textStatus);
						}else{
							opts.success(data, textStatus);
						}
					},
					"error" : function(jqXHR, textStatus, errorThrown) {
						opts.error($.totoRecommend.formatData({ "message" : { "id" : "", "body" : errorThrown }}), textStatus, errorThrown);
					}
				});
			},
			"formatData" : function(data) {
				if (!data || !data.message) {
					data = $.extend({
							"message" : { "id" : "MZZEG9999", "body" : "Unknown Error." }
					}, data || {});
				}
				return data;
			},
			"isSuccess" : function(data){
				if(data == null) return false;
				var status = data.status_code;
				if(status == null || status == "") return false;
				return status.indexOf("200") === 0;
			}
		};

	$(function() {

	});
})(window.jQuery, window.JSON);

